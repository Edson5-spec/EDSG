@using Microsoft.AspNetCore.Identity
@using EDSG.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    var user = await UserManager.GetUserAsync(User);
    var controller = ViewContext.RouteData.Values["controller"]?.ToString();
    var action = ViewContext.RouteData.Values["action"]?.ToString();
    var isDashboard = controller == "Dashboard";
    var isProfessionalMode = Context.Session.GetString("DashboardMode") == "Profissional";
}

<ul class="dropdown-menu dropdown-menu-end context-menu" aria-labelledby="contextMenuButton">
    <!-- Contextual Header -->
    <li class="dropdown-header context-header">
        <div class="d-flex align-items-center">
            <i class="bi @GetContextIcon(controller, action) me-2"></i>
            <div>
                <strong>@GetContextTitle(controller, action)</strong>
                <div class="small text-muted">@GetContextDescription(controller, action)</div>
            </div>
        </div>
    </li>
    <li><hr class="dropdown-divider"></li>
    
    <!-- Quick Actions based on context -->
    RenderQuickActions();
    
    <!-- Common Actions -->
    <li class="dropdown-header">Ações Comuns</li>
    <li>
        <a class="dropdown-item" asp-controller="Dashboard" asp-action="Index">
            <i class="bi bi-speedometer2"></i> Dashboard
            <span class="badge bg-primary float-end">Início</span>
        </a>
    </li>
    
    @if (isDashboard && isProfessionalMode)
    {
        <li>
            <a class="dropdown-item" asp-controller="Dashboard" asp-action="Servicos">
                <i class="bi bi-briefcase"></i> Meus Serviços
                <span class="badge bg-info float-end">Profissional</span>
            </a>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Dashboard" asp-action="Mensagens">
                <i class="bi bi-chat-dots"></i> Mensagens
                <span class="badge bg-success float-end" id="unreadCount">0</span>
            </a>
        </li>
    }
    else if (isDashboard && !isProfessionalMode)
    {
        <li>
            <a class="dropdown-item" asp-controller="Dashboard" asp-action="Favoritos">
                <i class="bi bi-heart"></i> Favoritos
            </a>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Dashboard" asp-action="Mensagens">
                <i class="bi bi-chat-dots"></i> Mensagens
                <span class="badge bg-success float-end" id="unreadCount">0</span>
            </a>
        </li>
    }
    
    <li>
        <a class="dropdown-item" asp-controller="Home" asp-action="Procurar">
            <i class="bi bi-search"></i> Procurar Profissionais
        </a>
    </li>
    
    @if (user?.Categoria != null)
    {
        <li>
            <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                <i class="bi bi-person-badge"></i> Meu Perfil Profissional
            </a>
        </li>
    }
    
    <!-- Premium Section -->
    @if (user?.IsPremium == true)
    {
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">
            <span class="text-warning">
                <i class="bi bi-star-fill"></i> Premium
            </span>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Premium" asp-action="Index">
                <i class="bi bi-graph-up"></i> Estatísticas Premium
            </a>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Premium" asp-action="Manage">
                <i class="bi bi-credit-card"></i> Gerir Assinatura
            </a>
        </li>
    }
    else
    {
        <li><hr class="dropdown-divider"></li>
        <li>
            <a class="dropdown-item text-warning" asp-controller="Premium" asp-action="Benefits">
                <i class="bi bi-star"></i> Tornar-se Premium
                <span class="badge bg-warning float-end">Novo</span>
            </a>
        </li>
    }
    
    <!-- Admin Section -->
    @if (User.IsInRole("Admin"))
    {
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header text-danger">
            <i class="bi bi-shield-check"></i> Administração
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Admin" asp-action="Index">
                <i class="bi bi-speedometer"></i> Dashboard Admin
            </a>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Admin" asp-action="Users">
                <i class="bi bi-people"></i> Gerir Utilizadores
            </a>
        </li>
        <li>
            <a class="dropdown-item" asp-controller="Admin" asp-action="Reports">
                <i class="bi bi-flag"></i> Denúncias
            </a>
        </li>
    }
    
    <!-- Bottom Section -->
    <li><hr class="dropdown-divider"></li>
    <li>
        <a class="dropdown-item" href="#">
            <i class="bi bi-gear"></i> Configurações
        </a>
    </li>
    <li>
        <a class="dropdown-item" href="#">
            <i class="bi bi-question-circle"></i> Ajuda & Suporte
        </a>
    </li>
    <li>
        <a class="dropdown-item" asp-controller="Home" asp-action="Contactos">
            <i class="bi bi-envelope"></i> Contactar-nos
        </a>
    </li>
</ul>

@functions {
    string GetContextIcon(string controller, string action)
    {
        return (controller, action) switch
        {
            ("Home", "Index") => "bi-house-gear",
            ("Home", "Procurar") => "bi-search",
            ("Dashboard", "Index") => "bi-speedometer",
            ("Dashboard", "Mensagens") => "bi-chat-dots",
            ("Dashboard", "Favoritos") => "bi-heart",
            ("Dashboard", "Servicos") => "bi-briefcase",
            ("Premium", _) => "bi-star",
            ("Admin", _) => "bi-shield-check",
            ("Account", "Profile") => "bi-person-gear",
            _ => "bi-gear"
        };
    }
    
    string GetContextTitle(string controller, string action)
    {
        return (controller, action) switch
        {
            ("Home", "Index") => "Página Inicial",
            ("Home", "Procurar") => "Procurar Profissionais",
            ("Dashboard", "Index") => "Dashboard",
            ("Dashboard", "Mensagens") => "Mensagens",
            ("Dashboard", "Favoritos") => "Favoritos",
            ("Dashboard", "Servicos") => "Meus Serviços",
            ("Premium", "Index") => "Área Premium",
            ("Premium", "Benefits") => "Benefícios Premium",
            ("Admin", "Index") => "Administração",
            ("Account", "Profile") => "Meu Perfil",
            _ => "Menu Rápido"
        };
    }
    
    string GetContextDescription(string controller, string action)
    {
        return (controller, action) switch
        {
            ("Home", "Index") => "Encontre os melhores profissionais",
            ("Home", "Procurar") => "Busque por categorias e localização",
            ("Dashboard", "Index") => "Gerencie sua conta",
            ("Dashboard", "Mensagens") => "Verifique suas conversas",
            ("Dashboard", "Favoritos") => "Profissionais favoritados",
            ("Dashboard", "Servicos") => "Gerencie seus serviços",
            ("Premium", "Index") => "Recursos exclusivos",
            ("Premium", "Benefits") => "Vantagens premium",
            ("Admin", "Index") => "Gestão do sistema",
            ("Account", "Profile") => "Configure seu perfil",
            _ => "Acesso rápido às funcionalidades"
        };
    }
}

@{
    async Task RenderQuickActions()
    {
        var user = await UserManager.GetUserAsync(User);
        
        <li class="dropdown-header">Ações Rápidas</li>
        
        switch (controller)
        {
            case "Home" when action == "Index":
                <li>
                    <a class="dropdown-item" asp-controller="Home" asp-action="Procurar">
                        <i class="bi bi-search"></i> Procurar Profissionais
                        <span class="badge bg-primary float-end">↗</span>
                    </a>
                </li>
                if (user?.Categoria != null)
                {
                    <li>
                        <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                            <i class="bi bi-pencil"></i> Atualizar Perfil
                        </a>
                    </li>
                }
                break;
                
            case "Home" when action == "Procurar":
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="bi bi-funnel"></i> Refinar Pesquisa
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#">
                        <i class="bi bi-save"></i> Salvar Pesquisa
                    </a>
                </li>
                break;
                
            case "Dashboard":
                var isProfessionalMode = Context.Session.GetString("DashboardMode") == "Profissional";
                
                if (isProfessionalMode)
                {
                    <li>
                        <a class="dropdown-item" asp-controller="Dashboard" asp-action="SwitchMode" 
                           asp-route-mode="Cliente">
                            <i class="bi bi-person"></i> Mudar para Cliente
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-controller="Dashboard" asp-action="Servicos">
                            <i class="bi bi-plus-circle"></i> Novo Serviço Concluído
                        </a>
                    </li>
                }
                else
                {
                    <li>
                        <a class="dropdown-item" asp-controller="Dashboard" asp-action="SwitchMode" 
                           asp-route-mode="Profissional">
                            <i class="bi bi-briefcase"></i> Mudar para Profissional
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-controller="Home" asp-action="Procurar">
                            <i class="bi bi-search"></i> Encontrar Profissional
                        </a>
                    </li>
                }
                break;
                
            case "Premium":
                if (user?.IsPremium == true)
                {
                    <li>
                        <a class="dropdown-item" asp-controller="Premium" asp-action="Manage">
                            <i class="bi bi-credit-card"></i> Gerir Pagamento
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-controller="Dashboard" asp-action="Index">
                            <i class="bi bi-graph-up"></i> Ver Estatísticas
                        </a>
                    </li>
                }
                else
                {
                    <li>
                        <a class="dropdown-item" asp-controller="Premium" asp-action="Upgrade">
                            <i class="bi bi-lightning-charge"></i> Tornar-se Premium
                        </a>
                    </li>
                }
                break;
                
            case "Admin":
                <li>
                    <a class="dropdown-item" asp-controller="Admin" asp-action="SystemStats">
                        <i class="bi bi-graph-up-arrow"></i> Estatísticas do Sistema
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-controller="Admin" asp-action="Users">
                        <i class="bi bi-person-plus"></i> Adicionar Utilizador
                    </a>
                </li>
                break;
        }
    }
}